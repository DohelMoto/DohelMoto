name: Compose CI + Update GitOps

on:
  push:
    branches: [ "main", "dev", "staging" ]
  pull_request:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
  BACKEND_REPO: ecommerce/dohelmoto-backend
  FRONTEND_REPO: ecommerce/dohelmoto-frontend
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout mono-repo
        uses: actions/checkout@v4

      - name: Create backend .env
        run: |
          mkdir -p backend
          cat > backend/.env <<'EOF'
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_BUCKET_NAME=${{ secrets.AWS_BUCKET_NAME }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          EOF

      - name: Quick compose smoke test
        run: |
          REACT_APP_API_URL="/api" NODE_ENV="development" docker compose build
          docker compose up -d --wait --wait-timeout 180 || true
          echo "==> FRONTEND LOGS:"; docker logs ecommerce_frontend || true
          echo "==> BACKEND LOGS:";  docker logs ecommerce_backend  || true
          echo "==> Health checks:"; curl -fsS http://localhost:8000/health || true
          curl -fsS http://localhost:3000 || true
          docker compose down -v --remove-orphans || true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Ensure ECR repositories exist
        run: |
          aws ecr describe-repositories --repository-names "$BACKEND_REPO" >/dev/null 2>&1 || \
            aws ecr create-repository --repository-name "$BACKEND_REPO" >/dev/null
          aws ecr describe-repositories --repository-names "$FRONTEND_REPO" >/dev/null 2>&1 || \
            aws ecr create-repository --repository-name "$FRONTEND_REPO" >/dev/null

      - name: Build backend image
        run: |
          docker build \
            -t $ECR_REGISTRY/$BACKEND_REPO:${IMAGE_TAG} \
            -t $ECR_REGISTRY/$BACKEND_REPO:latest \
            -f backend/Dockerfile backend

      - name: Push backend image
        run: |
          docker push $ECR_REGISTRY/$BACKEND_REPO:${IMAGE_TAG}
          docker push $ECR_REGISTRY/$BACKEND_REPO:latest

      - name: Build frontend image
        run: |
          docker build \
            --build-arg REACT_APP_API_URL=/api \
            --build-arg NODE_ENV=production \
            -t $ECR_REGISTRY/$FRONTEND_REPO:${IMAGE_TAG} \
            -t $ECR_REGISTRY/$FRONTEND_REPO:latest \
            -f frontend/Dockerfile frontend

      - name: Push frontend image
        run: |
          docker push $ECR_REGISTRY/$FRONTEND_REPO:${IMAGE_TAG}
          docker push $ECR_REGISTRY/$FRONTEND_REPO:latest

      - name: Verify images exist in ECR
        run: |
          aws ecr describe-images --repository-name "$BACKEND_REPO"  --image-ids imageTag=${IMAGE_TAG} --region "$AWS_REGION" --output table
          aws ecr describe-images --repository-name "$FRONTEND_REPO" --image-ids imageTag=${IMAGE_TAG} --region "$AWS_REGION" --output table

      - name: Determine environment
        run: |
          case "${GITHUB_REF_NAME}" in
            dev)     echo "ENV=dev"     >> $GITHUB_ENV ;;
            staging) echo "ENV=staging" >> $GITHUB_ENV ;;
            main)    echo "ENV=prod"    >> $GITHUB_ENV ;;
            *) echo "Unsupported branch ${GITHUB_REF_NAME}"; exit 1 ;;
          esac

      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: DohelMoto/DohelMoto-GitOps
          path: gitops
          token: ${{ secrets.GITOPS_PUSH_TOKEN }}

      - name: Install yq
        run: sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 && sudo chmod +x /usr/local/bin/yq

      - name: Update image tags in GitOps values
        run: |
          set -e
          test -n "${ENV:-}" || { echo "ENV not set"; exit 1; }
          yq -i '.images.backend.tag  = env(IMAGE_TAG)'  gitops/environments/$ENV/values.yaml
          yq -i '.images.frontend.tag = env(IMAGE_TAG)'  gitops/environments/$ENV/values.yaml

      - name: Commit & push GitOps update
        working-directory: gitops
        run: |
          git config user.name  "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Deploy $ENV - image tag $IMAGE_TAG" || echo "No changes to commit"
          git push origin HEAD

